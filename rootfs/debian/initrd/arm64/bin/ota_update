#!/bin/sh 
#set -x
# Source debconf library.
. /usr/share/debconf/confmodule

MAX_STEPS=100
FLAG=/var/log/INSTALL_OK
FAIL_FLAG=/var/log/INSTALL_FAILED
INSTALL_PROGRESSBAR=ota-update-info/progress-bar
UPDATE_IMAGE_PATH=/userdata/update.img
OTA_UPATE_LOG=/var/log/ota_update.log

ota_clean() {
	updateEngine --cleanmisc >> $OTA_UPATE_LOG
	sync
}

ota_update() {
	updateEngine --update --image_url=$UPDATE_IMAGE_PATH --savepath=$UPDATE_IMAGE_PATH  --partition=0x3A0000 > $OTA_UPATE_LOG
	RES=$?
	#进度条太快闪过画面会消失
	sleep 4
	touch $FLAG
	sync
	if [ "$RES" == "0" ]; then
		ota_clean
	else
		touch $FAIL_FLAG
	fi
}

show_progress_bar () {
	db_progress START 0 $MAX_STEPS $INSTALL_PROGRESSBAR
	# db_progress INFO rootfs-install-info/progress-bar
	percent=0
	step=1
	while [  ! -f $FLAG ]
    do
		sleep 1
		percent=$((percent+step)) 
		if [ x"$percent" != x"99" ];then
        	db_progress STEP $step
		else
			db_progress SET 50
    	fi
		if [  -f $FAIL_FLAG ]; then
			break
		fi
    done
	db_progress SET $MAX_STEPS
	sleep 3
	db_progress STOP
	db_go

 	if [  ! -f $FAIL_FLAG ]; then
		db_metaget ota-finish-info/finish-info Description
		db_subst ota-finish-info/finish-info Description $RET
		db_fset ota-finish-info/finish-info seen false || true
		db_input critical ota-finish-info/finish-info || true
		sleep 3
		reboot
		db_go || true

	else
		db_metaget ota-finish-info-2/finish-info Description
		db_subst ota-finish-info-2/finish-info Description $RET
		db_fset ota-finish-info-2/finish-info seen false || true
		db_input critical ota-finish-info-2/finish-info || true
		db_go || true
	fi

}

boot_update=$(updateEngine --misc=display | grep update_package)
if [ -z "${boot_update}" ]; then
	exit 0
fi
ota_update &
show_progress_bar
exit 10
