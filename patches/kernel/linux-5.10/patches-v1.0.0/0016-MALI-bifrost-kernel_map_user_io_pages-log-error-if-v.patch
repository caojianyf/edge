From cb1ac2e1f1530b9a55dc5cc01e0047034b9b5c2b Mon Sep 17 00:00:00 2001
From: Zhen Chen <chenzhen@rock-chips.com>
Date: Thu, 19 May 2022 16:10:46 +0800
Subject: [PATCH 16/24] MALI: bifrost: kernel_map_user_io_pages(): log error if
 vmap() returns NULL.

Change-Id: Ie1d3682cc32fc191815210f19198b1b4922d830d
Signed-off-by: Zhen Chen <chenzhen@rock-chips.com>
---
 drivers/gpu/arm/bifrost/csf/mali_kbase_csf.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/arm/bifrost/csf/mali_kbase_csf.c b/drivers/gpu/arm/bifrost/csf/mali_kbase_csf.c
index dd1528711d47..497e05c9b691 100644
--- a/drivers/gpu/arm/bifrost/csf/mali_kbase_csf.c
+++ b/drivers/gpu/arm/bifrost/csf/mali_kbase_csf.c
@@ -261,10 +261,15 @@ static int kernel_map_user_io_pages(struct kbase_context *kctx,
 
 	queue->user_io_addr = vmap(page_list, ARRAY_SIZE(page_list), VM_MAP, cpu_map_prot);
 
-	if (!queue->user_io_addr)
+	if (!queue->user_io_addr) {
+		dev_err(kctx->kbdev->dev,
+			"%s(): queue->user_io_addr is NULL, queue: %p",
+			__func__,
+			queue);
 		ret = -ENOMEM;
-	else
+	} else {
 		atomic_add(ARRAY_SIZE(page_list), &kctx->permanent_mapped_pages);
+	}
 
 unlock:
 	kbase_gpu_vm_unlock(kctx);
-- 
2.30.2

